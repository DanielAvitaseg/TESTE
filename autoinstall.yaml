#cloud-config
autoinstall:
  version: 1
  
  # ====================================================================
  # CONFIGURA√á√ÉO DE ARMAZENAMENTO (MAIS SIMPLES)
  # ====================================================================
  storage:
    wipe: all
    layout:
      name: lvm
      match: 
        path: /dev/nvme0n1
      password: Senhafoda123@ 

  # ====================================================================
  # CONFIGURA√á√ïES DE SISTEMA
  # ====================================================================
  identity:
    hostname: notebook-ubuntu
    username: testuser
    # Usando o hash fornecido anteriormente, que √© o formato mais seguro
    password: "$6$EAyehhfqepzaGX78$k4Qceki0nxJKS2.ZxcWyWjn7db3p7/0Qu.S6pr32pIqVpzfFmwnOj/.XKgY6x3ADG077lE.DoNwMpXZ2aXr3q." 
    
  locale: pt_BR
  timezone: America/Sao_Paulo
  
  keyboard:
    layout: br

  # ====================================================================
  # P√ìS-INSTALA√á√ÉO E A√á√ÉO FINAL
  # ====================================================================
  late-commands:
    # Comandos de atualiza√ß√£o inicial
    - curtin in-target -- apt update
    - curtin in-target -- apt upgrade -y
    
    # ===================================================================
    # IN√çCIO DA INSTALA√á√ÉO DAS FERRAMENTAS DE DESENVOLVIMENTO
    # (TODOS OS COMANDOS S√ÉO ENCAPSULADOS POR 'curtin in-target --')
    # ===================================================================

    - curtin in-target -- echo "üõ†Ô∏è Iniciando a instala√ß√£o das ferramentas de desenvolvimento..."

    # --- 1. PREPARA√á√ÉO GERAL (CURL GARANTIDO) ---
    - curtin in-target -- echo "--- 1. Preparando o sistema (Update e pacotes base, incluindo curl) ---"
    # O 'apt update' e 'apt upgrade' j√° foram feitos acima, mas os pacotes base s√£o importantes
    - curtin in-target -- sudo apt install -y apt-transport-https ca-certificates curl software-properties-common wget gpg lsb-release

    # --- 2. INSTALA√á√ÉO DO DBEAVER CE ---
    - curtin in-target -- echo "--- 2. Instalando DBeaver CE ---"
    - curtin in-target -- echo "deb https://dbeaver.io/debs/dbeaver-ce /" | sudo tee /etc/apt/sources.list.d/dbeaver.list > /dev/null
    # Nota: A maneira de adicionar a chave GPG foi adaptada para ser amig√°vel ao curtin/tee
    - curtin in-target -- wget -O - https://dbeaver.io/debs/dbeaver.gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/dbeaver.gpg > /dev/null
    - curtin in-target -- apt update
    - curtin in-target -- apt install -y dbeaver-ce

    # --- 3. INSTALA√á√ÉO DO DOCKER & DOCKER COMPOSE ---
    - curtin in-target -- echo "--- 3. Instalando Docker e Docker Compose ---"
    - curtin in-target -- sudo install -m 0755 -d /etc/apt/keyrings
    - curtin in-target -- curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    - curtin in-target -- sudo chmod a+r /etc/apt/keyrings/docker.gpg
    - curtin in-target -- VERSION_CODENAME=$(lsb_release -cs)
    # A linha com 'echo' foi encapsulada para funcionar dentro do 'curtin in-target --'
    - curtin in-target -- sh -c 'echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $VERSION_CODENAME stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null'
    - curtin in-target -- apt update
    - curtin in-target -- apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    # Instalando Docker Compose V1 (para compatibilidade com scripts legados)
    - curtin in-target -- DOCKER_COMPOSE_VERSION="1.29.2"
    - curtin in-target -- sudo curl -L "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    - curtin in-target -- sudo chmod +x /usr/local/bin/docker-compose

    - curtin in-target -- sudo systemctl enable docker
    # O comando abaixo adiciona o usu√°rio 'testuser' ao grupo 'docker'
    - curtin in-target -- if ! grep -q "docker" /etc/group; then sudo groupadd docker; fi
    - curtin in-target -- sudo usermod -aG docker testuser # Usando 'testuser' em vez de '$USER'

    # --- 4. INSTALA√á√ÉO DO .NET SDK 6.0 ---
    - curtin in-target -- echo "--- 4. Instalando .NET SDK 6.0 ---"
    - curtin in-target -- DOTNET_INSTALLER_PATH="/home/testuser/dotnet-install.sh"
    - curtin in-target -- wget https://dot.net/v1/dotnet-install.sh -O "$DOTNET_INSTALLER_PATH"
    - curtin in-target -- chmod +x "$DOTNET_INSTALLER_PATH"
    # Executa como o usu√°rio 'testuser' para instalar no seu diret√≥rio home
    - curtin in-target -- runuser -l testuser -c '"$DOTNET_INSTALLER_PATH" --channel 6.0'
    - curtin in-target -- rm "$DOTNET_INSTALLER_PATH"

    # --- 5. INSTALA√á√ÉO DO NVM (Node Version Manager) e Node.js 18 ---
    - curtin in-target -- echo "--- 5. Instalando NVM e Node.js 18 ---"
    # Instala o NVM como o usu√°rio 'testuser'
    - curtin in-target -- runuser -l testuser -c 'curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash'
    
    # Configura e instala o Node.js 18 como 'testuser'. Necess√°rio carregar o NVM
    - curtin in-target -- runuser -l testuser -c 'export NVM_DIR="/home/testuser/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm install 18 && nvm use 18'

    # --- 6. INSTALA√á√ÉO DO POSTMAN ---
    - curtin in-target -- echo "--- 6. Instalando Postman ---"
    - curtin in-target -- POSTMAN_URL="https://dl.pstmn.io/download/latest/linux64"
    - curtin in-target -- POSTMAN_TAR="/home/testuser/postman.tar.gz"
    - curtin in-target -- wget "$POSTMAN_URL" -O "$POSTMAN_TAR"
    - curtin in-target -- sudo tar -xzf "$POSTMAN_TAR" -C /opt
    - curtin in-target -- sudo ln -sf /opt/Postman/Postman /usr/bin/postman
    - curtin in-target -- rm "$POSTMAN_TAR"

    # Criando o atalho .desktop (usando um bloco de estilo literal |)
    - |
      curtin in-target -- tee /usr/share/applications/postman.desktop > /dev/null << EOF
      [Desktop Entry]
      Type=Application
      Name=Postman
      Icon=/opt/Postman/app/resources/app/assets/icon.png
      Exec="/opt/Postman/Postman"
      Comment=Postman Desktop App
      Categories=Development;Code;
      EOF

    # --- 7. INSTALA√á√ÉO DO SLACK ---
    - curtin in-target -- echo "--- 7. Instalando Slack ---"
    - curtin in-target -- SLACK_URL="https://downloads.slack-edge.com/desktop-releases/linux/x64/4.46.101/slack-desktop-4.46.101-amd64.deb"
    - curtin in-target -- SLACK_DEB="/home/testuser/slack.deb"
    - curtin in-target -- wget "$SLACK_URL" -O "$SLACK_DEB"
    - curtin in-target -- sudo apt install "$SLACK_DEB" -y
    - curtin in-target -- rm "$SLACK_DEB"

    # --- 8. INSTALA√á√ÉO DO VS CODE E EXTENS√ïES ---
    - curtin in-target -- echo "--- 8. Instalando VS Code e Extens√µes ---"
    - curtin in-target -- curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /tmp/microsoft.gpg # Usando /tmp
    - curtin in-target -- sudo install -o root -g root -m 644 /tmp/microsoft.gpg /etc/apt/keyrings/
    - curtin in-target -- sh -c 'echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/vscode stable main" > /etc/apt/sources.list.d/vscode.list'
    - curtin in-target -- rm /tmp/microsoft.gpg
    - curtin in-target -- apt update
    - curtin in-target -- apt install -y code

    - curtin in-target -- echo "Instalando extens√µes do VS Code (executando como testuser)..."
    # Instalar extens√µes VS Code como 'testuser'
    # Nota: A instala√ß√£o de extens√µes dentro do late-commands pode ser problem√°tica.
    # Usaremos 'runuser' para simular a execu√ß√£o como 'testuser'.
    - curtin in-target -- runuser -l testuser -c '
        if command -v code &> /dev/null; then
            EXTENSIONS=(
                ms-dotnettools.vscode-dotnet-runtime
                ms-dotnettools.csharp
                Angular.ng-template
                johnpapa.angular2
                fernandoescolar.vscode-solution-explorer
                esbenp.prettier-vscode
                ms-dotnettools.vscodeintellicode-csharp
                dbaeumer.vscode-eslint
                rangav.vscode-thunder-client
            )
            for EXT in "${EXTENSIONS[@]}"; do
                code --install-extension "$EXT" --force
            done
        fi
    '

   
    
  # CORRE√á√ÉO 3: 'power-state' deve ser de n√≠vel superior
  power-state:
    delay: 5
    mode: reboot
