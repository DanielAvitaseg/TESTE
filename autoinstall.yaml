#cloud-config
autoinstall:
    version: 1
    identity:
        realname: 'Dionatan Simioni'
        hostname: ubuntu-desktop
        username: diolinux
        password: '$y$j9T$uhkxlm8nUQaNu.6rl4k2d.$DIldpYy96OHg8lFjfXfc671BZcGWkPOmaDONGAhGSg3'
    locale: pt_BR.utf8
    keyboard:
        layout: br
    timezone: "America/Sao_Paulo"    
    
    # --- Configuração de Armazenamento com Criptografia LVM ---
    storage:
        config:
            - id: disk-sda
              type: disk
              name: sda
              match:
                # Se o seu disco for NVMe, mude 'sda' para 'nvme0n1'
                uuid: 
              ptable: gpt
              wipe: superblock-recursive
            
            # 1. Partição /boot
            - id: partition-0
              type: partition
              disk: disk-sda
              size: 536870912 # 512 MB
              flag: boot
              grub_device: true
            
            # 2. Partição principal (o restante do disco)
            - id: partition-1
              type: partition
              disk: disk-sda
              size: 0 
              
            # 3. Criptografia da partição principal (LUKS)
            - id: encryption-0
              type: encrypt
              volume: partition-1
              # CORREÇÃO CRÍTICA: O hash deve estar em UMA ÚNICA LINHA!
              password: '$6$dEsPnw6B0uPMsJtg$R8DQ9KoMZIR5/RW690CIyXcx/qQWQPBu1Ov0u9ctiWvibXbQB4vgPDbMDpPw3mNx08HNhL9Or3F9RL/rxiQJK0'
              
            # 4. Volume Group LVM sobre a partição criptografada
            - id: volgroup-0
              type: lvm_volgroup
              name: vg-system
              volumes:
                - encryption-0
                
            # 5. Logical Volume (raiz)
            - id: logicalvolume-0
              type: lvm_partition
              volgroup: volgroup-0
              size: 0
              name: lv-root
              
            # 6. Formatação e Montagem
            - id: format-0
              type: format
              volume: partition-0
              fstype: ext4
            - id: format-1
              type: format
              volume: logicalvolume-0
              fstype: ext4
            
            - id: mount-0
              type: mount
              volume: format-0
              path: /boot
            - id: mount-1
              type: mount
              volume: format-1
              path: /
              
    # --- Configurações de Software ---
    packages:
        - libreoffice
        - gimp
        - git
        - wget
        - docker.io
        - apt-transport-https 
        - ca-certificates
        - curl
        - gnupg
        - lsb-release
    snaps:
        - name: spotify
          channel: stable
          classic: false
        - name: postman 
          channel: stable
          classic: false
        - name: slack
          channel: stable
          classic: false
        - name: code # VS Code
          channel: stable
          classic: true 
        - name: dbeaver-ce 
          channel: stable
          classic: false
    codecs:
        install: true
    drivers:
        install: true
    updates: all
    shutdown: reboot
    
    # --- Comandos Pós-Instalação (NVM) ---
    late-commands:
        # Simplificado para apenas executar a instalação do NVM no usuário 'diolinux'
        - |
          su - diolinux -c "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh | bash"
