#cloud-config
autoinstall:
  version: 1

  # ====================================================================
  # CONFIGURA√á√ÉO DE ARMAZENAMENTO
  # ====================================================================
  storage:
    wipe: all
    layout:
      name: lvm
      match:  
        path: /dev/nvme0n1
      
      # SENHA DE CRIPTOGRAFIA (LUKS)
      password: "Avita123"

  # ====================================================================
  # CONFIGURA√á√ïES DE SISTEMA (Identidade e Localiza√ß√£o)
  # ====================================================================
  identity:
    hostname: daniel_sammartano
    username: testefinal
    # SENHA DO USU√ÅRIO ALTERADA PARA Senhafoda123@ (string simples)
    password: "Avita123"
    
  locale: pt_BR
  timezone: America/Sao_Paulo
  
  keyboard:
    layout: br

  # ====================================================================
  # INSTALA√á√ÉO DECLARATIVA DE APLICATIVOS (APT e SNAP)
  # ====================================================================
  packages:
    # Pacotes APT essenciais (Docker, Git, utilit√°rios, libglib2.0-bin para gsettings)
    - docker.io
    - git
    - gimp
    # Pacotes de utilit√°rios que podem ser necess√°rios para o resto
    - apt-transport-https
    - ca-certificates
    - curl
    - gnupg
    - lsb-release
    - wget
    - libglib2.0-bin # Necess√°rio para o comando 'gsettings'
    - docker-compose-plugin # Instala a nova vers√£o do docker compose

  snaps:
    # Aplica√ß√µes instaladas via Snap Store
    - name: spotify
      channel: stable
    - name: postman
      channel: stable
    - name: slack
      channel: stable
    - name: code # VS Code
      channel: stable
      classic: true
    - name: dbeaver-ce
      channel: stable
      
  # Configura√ß√µes adicionais
  codecs:
    install: true
  drivers:
    install: true
  updates: all

  # ====================================================================
  # COMANDOS DE P√ìS-INSTALA√á√ÉO (Executados como ROOT durante a instala√ß√£o)
  # ====================================================================
  late-commands:
    # 1. Update/Upgrade inicial
    - curtin in-target -- apt update
    - curtin in-target -- apt upgrade -y
    
    # 2. Adiciona o usu√°rio 'testefinal' ao grupo 'docker'
    - curtin in-target -- usermod -aG docker testefinal
    - curtin in-target -- echo "‚úÖ Usu√°rio 'testefinal' adicionado ao grupo 'docker'."
      
  # ====================================================================
  # CONFIGURA√á√ÉO DE USU√ÅRIO (Executado no PRIMEIRO BOOT)
  # ====================================================================
  user-data:
    runcmd:
      # Os comandos s√£o executados como ROOT, ent√£o usamos 'su -' para mudar para o usu√°rio 'testefinal'.
      - su - testefinal -c '
        echo "üõ†Ô∏è Iniciando configura√ß√£o de ambiente do usu√°rio (testefinal)..."
        
        # Define a vari√°vel HOME no shell do usu√°rio
        export HOME=/home/testefinal
        
        # 1. Baixa o wallpaper para a pasta Downloads
        echo "‚¨áÔ∏è Baixando wallpaper..."
        wget https://i.ibb.co/cwtDVCS/Frame-6.png -O $HOME/Downloads/Frame-6.png
        
        # 2. Define o wallpaper usando gsettings (executado no contexto do usu√°rio)
        echo "üñºÔ∏è Aplicando wallpaper..."
        gsettings set org.gnome.desktop.background picture-uri "file://$HOME/Downloads/Frame-6.png"
        gsettings set org.gnome.desktop.background picture-uri-dark "file://$HOME/Downloads/Frame-6.png"
        echo "‚úÖ Wallpaper aplicado."

        echo "üéâ Configura√ß√£o de usu√°rio conclu√≠da."
      '
      
  power-state:
    delay: 5
    mode: reboot
